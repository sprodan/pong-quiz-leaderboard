<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Pong Quiz 10s</title>
  <style>
    :root { color-scheme: dark; }
    body { margin: 0; font-family: -apple-system, Inter, system-ui, sans-serif; background: #0c1222; color: #eef3ff; }
    .wrap { max-width: 760px; margin: 0 auto; padding: 14px; }
    h1 { margin: 0 0 6px; font-size: 24px; }
    .sub { opacity: .85; margin-bottom: 12px; }
    .card { background: #141c33; border: 1px solid #24315f; border-radius: 14px; padding: 12px; margin-bottom: 12px; }
    canvas { width: 100%; max-width: 720px; height: auto; border-radius: 12px; background: linear-gradient(#0f1730, #0a1022); touch-action: none; display: block; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    button, input, select { font-size: 16px; border-radius: 10px; border: 1px solid #34467f; background: #1a2750; color: #fff; padding: 10px 12px; }
    button { cursor: pointer; }
    button.primary { background: #2a56ff; border-color: #3f67ff; font-weight: 700; }
    .hidden { display: none; }
    .stats { font-size: 18px; font-weight: 600; }
    .q { font-size: 18px; margin-bottom: 10px; }
    .answers { display: grid; gap: 8px; }
    ol { margin: 8px 0 0; padding-left: 22px; }
    .muted { opacity: .8; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>üèì Pong + Quiz (10 —Å–µ–∫—É–Ω–¥)</h1>
    <div class="sub">–ò–≥—Ä–∞–π 10—Å, –Ω–∞–±–µ—Ä–∏ –æ—á–∫–∏, –æ—Ç–≤–µ—Ç—å –Ω–∞ —Å–ª—É—á–∞–π–Ω—ã–π –≤–æ–ø—Ä–æ—Å (–∏–≥—Ä—ã/–∫–∏–Ω–æ/–º–µ–º—ã) ‚Äî –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç = x2.</div>

    <div class="card">
      <canvas id="game" width="720" height="420"></canvas>
      <div class="row" style="margin-top:10px">
        <button id="start" class="primary">–°—Ç–∞—Ä—Ç</button>
        <span class="stats" id="stats">–í—Ä–µ–º—è: 10.0—Å | –û—á–∫–∏: 0</span>
      </div>
      <div class="muted" style="margin-top:8px">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —Å–≤–∞–π–ø/–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –ø–æ —ç–∫—Ä–∞–Ω—É –∏–ª–∏ ‚Üê ‚Üí.</div>
    </div>

    <div class="card hidden" id="quizCard">
      <div class="q" id="question"></div>
      <div class="answers" id="answers"></div>
    </div>

    <div class="card hidden" id="resultCard">
      <div id="resultText" style="font-size:20px;font-weight:700"></div>
      <div class="row" style="margin-top:10px">
        <input id="playerName" placeholder="–ò–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä stas)" maxlength="20" />
        <button id="shareBtn" class="primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —á–∞—Ç</button>
        <button id="challengeBtn">–ö–∏–Ω—É—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂ –¥—Ä—É–≥—É</button>
      </div>
      <div class="muted" style="margin-top:8px">–ö–Ω–æ–ø–∫–∞ –æ—Ç–∫—Ä–æ–µ—Ç Telegram/Share –∏ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç –≥–æ—Ç–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è @stas_a_bot.</div>
    </div>

    <div class="card">
      <div style="font-size:18px;font-weight:700">–õ–æ–∫–∞–ª—å–Ω—ã–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ (–Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ)</div>
      <ol id="localLb"></ol>
      <div class="muted">–û–±—â–∏–π –ª–∏–¥–µ—Ä–±–æ—Ä–¥ –≤–µ–¥—ë—Ç—Å—è –±–æ—Ç–æ–º –≤ —Ñ–∞–π–ª–µ leaderboard.json –∏ –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è –≤ —á–∞—Ç–µ.</div>
    </div>
  </div>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const startBtn = document.getElementById('start');
  const stats = document.getElementById('stats');
  const quizCard = document.getElementById('quizCard');
  const resultCard = document.getElementById('resultCard');
  const qEl = document.getElementById('question');
  const ansEl = document.getElementById('answers');
  const resultText = document.getElementById('resultText');
  const shareBtn = document.getElementById('shareBtn');
  const challengeBtn = document.getElementById('challengeBtn');
  const playerName = document.getElementById('playerName');
  const localLb = document.getElementById('localLb');

  let running = false;
  let score = 0;
  let timeLeft = 10;
  let lastTs = 0;
  let gameEnded = false;

  const paddleW = 120, paddleH = 12;
  const player = { x: 300, y: canvas.height - 24, w: paddleW, h: paddleH };
  const ai = { x: 300, y: 12, w: paddleW, h: paddleH };
  const ball = { x: canvas.width/2, y: canvas.height/2, r: 8, vx: 0, vy: 0 };
  const BASE_BALL_SPEED = 25; // –≤ 2 —Ä–∞–∑–∞ –º–µ–¥–ª–µ–Ω–Ω–µ–µ
  const PHYSICS_STEP = 1/240; // –º–µ–ª–∫–∏–π —à–∞–≥, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –∫–æ–ª–ª–∏–∑–∏–∏ –Ω–∞ –≤—ã—Å–æ–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏

  const questions = [
    // –ò–≥—Ä—ã
    { q: '–ö–∞–∫—É—é —Å—Ç—É–¥–∏—é –æ–±—ã—á–Ω–æ —Å–≤—è–∑—ã–≤–∞—é—Ç —Å —Å–µ—Ä–∏–µ–π Half-Life?', a: ['Valve', 'Ubisoft', 'EA'], c: 0 },
    { q: '–í Minecraft —Ä–µ–¥—Å—Ç–æ—É–Ω –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ—Ö–æ–∂ –Ω–∞‚Ä¶', a: ['–≠–ª–µ–∫—Ç—Ä–æ—Å—Ö–µ–º—ã', '–ö—É–ª–∏–Ω–∞—Ä–∏—é', '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç'], c: 0 },
    { q: '–ß—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ battle royale?', a: ['Fortnite', 'Stardew Valley', 'The Sims'], c: 0 },
    { q: '–í –∫–∞–∫–æ–π –∏–≥—Ä–µ –µ—Å—Ç—å –∞–≥–µ–Ω—Ç 47?', a: ['Hitman', 'Overwatch', 'Brawl Stars'], c: 0 },
    { q: 'Pong ‚Äî —ç—Ç–æ –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å‚Ä¶', a: ['–ê—Ä–∫–∞–¥–∞', 'MMORPG', '–°—Ç—Ä–∞—Ç–µ–≥–∏—è 4X'], c: 0 },
    { q: '–°–∫–æ–ª—å–∫–æ –æ—á–∫–æ–≤ –¥–∞—ë—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –∑–¥–µ—Å—å?', a: ['x2', '+1', 'x10'], c: 0 },

    // –ö–∏–Ω–æ / —Å–µ—Ä–∏–∞–ª—ã
    { q: '–ö—Ç–æ —Ä–µ–∂–∏—Å—Å—ë—Ä ‚Äú–ò–Ω—Ç–µ—Ä—Å—Ç–µ–ª–ª–∞—Ä–∞‚Äù?', a: ['–ö—Ä–∏—Å—Ç–æ—Ñ–µ—Ä –ù–æ–ª–∞–Ω', '–î–µ–Ω–∏ –í–∏–ª—å–Ω—ë–≤', '–ì–∞–π –†–∏—á–∏'], c: 0 },
    { q: '–ò–∑ –∫–∞–∫–æ–π –≤—Å–µ–ª–µ–Ω–Ω–æ–π ‚Äú–ú–∞–Ω–¥–∞–ª–æ—Ä–µ—Ü‚Äù?', a: ['Star Wars', 'Star Trek', 'Dune'], c: 0 },
    { q: '‚ÄúBreaking Bad‚Äù ‚Äî —ç—Ç–æ –ø—Ä–æ‚Ä¶', a: ['–£—á–∏—Ç–µ–ª—è —Ö–∏–º–∏–∏', '–®–µ—Ñ-–ø–æ–≤–∞—Ä–∞', '–ü–∏–ª–æ—Ç–∞ —Å–∞–º–æ–ª—ë—Ç–∞'], c: 0 },

    // –û–±—â–∏–µ/–º–µ–º–Ω—ã–µ
    { q: '–ß—Ç–æ —á–∞—â–µ –≤—Å–µ–≥–æ —Ä–µ—à–∞–µ—Ç –≤ –∫–æ—Ä–æ—Ç–∫–æ–π –∞—Ä–∫–∞–¥–µ?', a: ['–†–µ–∞–∫—Ü–∏—è', '–î–∏–ø–ª–æ–º', '–ì–æ—Ä–æ—Å–∫–æ–ø'], c: 0 },
    { q: '–õ—É—á—à–∏–π —Å–ø–æ—Å–æ–± –¥–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ —Ç—ã —Ç–∞—â–∏—à—å?', a: ['–ü–æ–±–∏—Ç—å —Ä–µ–∫–æ—Ä–¥', '–°–ø–æ—Ä–∏—Ç—å –≤ —á–∞—Ç–µ', '–°–¥–µ–ª–∞—Ç—å —Å–µ–ª—Ñ–∏ —Å –¥–∂–æ–π—Å—Ç–∏–∫–æ–º'], c: 0 },
    { q: '–ï—Å–ª–∏ –¥—Ä—É–≥ –æ–±–æ–≥–Ω–∞–ª —Ç–µ–±—è –≤ —Ç–æ–ø–µ, —á—Ç–æ –¥–µ–ª–∞—Ç—å?', a: ['–ò–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞—É–Ω–¥', '–£–¥–∞–ª–∏—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç', '–°–º–µ–Ω–∏—Ç—å –∏–º—è'], c: 0 }
  ];

  function resetBall(dir=1){
    ball.x = canvas.width/2; ball.y = canvas.height/2;
    const angle = (Math.random()*1.2 - 0.6);
    const speed = BASE_BALL_SPEED;
    ball.vx = speed * Math.sin(angle);
    ball.vy = speed * dir;
  }

  function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle = '#8fb5ff';
    ctx.fillRect(player.x, player.y, player.w, player.h);
    ctx.fillStyle = '#ffb48f';
    ctx.fillRect(ai.x, ai.y, ai.w, ai.h);
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2);
    ctx.fillStyle = '#fff';
    ctx.fill();
    ctx.setLineDash([6,7]);
    ctx.strokeStyle = '#2d3b69';
    ctx.beginPath();
    ctx.moveTo(0, canvas.height/2); ctx.lineTo(canvas.width, canvas.height/2); ctx.stroke();
    ctx.setLineDash([]);
  }

  function update(dt){
    // AI follows ball with delay
    ai.x += (ball.x - (ai.x + ai.w/2)) * 0.08;
    ai.x = clamp(ai.x, 0, canvas.width - ai.w);

    // substeps: —á—Ç–æ–±—ã –∫–æ–ª–ª–∏–∑–∏–∏ –Ω–µ –ø—Ä–æ–ª–µ—Ç–∞–ª–∏—Å—å –Ω–∞ –≤—ã—Å–æ–∫–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
    let remain = dt;
    while (remain > 0) {
      const step = Math.min(PHYSICS_STEP, remain);
      remain -= step;

      ball.x += ball.vx * step * 60;
      ball.y += ball.vy * step * 60;

      if(ball.x - ball.r < 0 || ball.x + ball.r > canvas.width) ball.vx *= -1;

      // AI paddle collision
      if(ball.y - ball.r <= ai.y + ai.h && ball.y >= ai.y && ball.x >= ai.x && ball.x <= ai.x + ai.w && ball.vy < 0){
        ball.vy = Math.abs(ball.vy);
        ball.vx += (ball.x - (ai.x + ai.w/2)) * 0.012;
        ball.y = ai.y + ai.h + ball.r;
      }
      // Player paddle collision (+1 –∑–∞ –∫–∞–∂–¥—ã–π –æ—Ç–±–∏—Ç—ã–π –º—è—á)
      if(ball.y + ball.r >= player.y && ball.y <= player.y + player.h && ball.x >= player.x && ball.x <= player.x + player.w && ball.vy > 0){
        ball.vy = -Math.abs(ball.vy);
        ball.vx += (ball.x - (player.x + player.w/2)) * 0.016;
        ball.y = player.y - ball.r;
        score += 1;
      }

      // –ï—Å–ª–∏ –º—è—á –≤—ã—à–µ–ª –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –ø–æ–ª—è ‚Äî –ø—Ä–æ—Å—Ç–æ —Ä–µ—Å–ø–∞–≤–Ω
      if(ball.y < -30){ resetBall(1); }
      if(ball.y > canvas.height + 30){ resetBall(-1); }
    }

    timeLeft -= dt;
    if(timeLeft <= 0){ endGame(); }
    stats.textContent = `–í—Ä–µ–º—è: ${Math.max(0,timeLeft).toFixed(1)}—Å | –û—á–∫–∏: ${score}`;
  }

  function loop(ts){
    if(!running) return;
    if(!lastTs) lastTs = ts;
    const dt = (ts - lastTs)/1000;
    lastTs = ts;
    update(dt);
    draw();
    if(running) requestAnimationFrame(loop);
  }

  function startGame(){
    running = true; gameEnded = false; score = 0; timeLeft = 10; lastTs = 0;
    quizCard.classList.add('hidden');
    resultCard.classList.add('hidden');
    resetBall(Math.random() > 0.5 ? 1 : -1);
    requestAnimationFrame(loop);
  }

  function endGame(){
    if(gameEnded) return;
    running = false; gameEnded = true;
    askQuiz();
  }

  function askQuiz(){
    quizCard.classList.remove('hidden');
    ansEl.innerHTML = '';
    const q = questions[Math.floor(Math.random()*questions.length)];
    qEl.textContent = `–í–æ–ø—Ä–æ—Å: ${q.q}`;
    q.a.forEach((txt, idx) => {
      const b = document.createElement('button');
      b.textContent = txt;
      b.onclick = () => finish(idx === q.c);
      ansEl.appendChild(b);
    });
  }

  function getLocalScores(){
    try { return JSON.parse(localStorage.getItem('pong_quiz_scores') || '[]'); } catch { return []; }
  }
  function setLocalScores(v){ localStorage.setItem('pong_quiz_scores', JSON.stringify(v)); }

  function renderLocalLb(){
    const rows = getLocalScores().sort((a,b)=>b.score-a.score).slice(0,10);
    localLb.innerHTML = rows.map(r => `<li>${r.name}: <b>${r.score}</b></li>`).join('') || '<li>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</li>';
  }

  let finalScore = 0;

  function finish(correct){
    quizCard.classList.add('hidden');
    finalScore = correct ? score * 2 : score;
    const local = getLocalScores();
    const name = (playerName.value || 'player').slice(0,20);
    local.push({ name, score: finalScore, ts: Date.now() });
    setLocalScores(local);
    renderLocalLb();

    resultCard.classList.remove('hidden');
    resultText.textContent = `${correct ? '‚úÖ –í–µ—Ä–Ω–æ! x2.' : '‚ùå –ù–µ–≤–µ—Ä–Ω–æ.'} –ò—Ç–æ–≥: ${finalScore} –æ—á–∫–æ–≤.`;
  }

  startBtn.onclick = startGame;

  function movePlayerTo(clientX){
    const rect = canvas.getBoundingClientRect();
    const x = clientX - rect.left;
    player.x = clamp(x - player.w/2, 0, canvas.width - player.w);
  }
  let dragging = false;
  canvas.addEventListener('pointerdown', e => { dragging = true; movePlayerTo(e.clientX); });
  canvas.addEventListener('pointermove', e => { if(dragging) movePlayerTo(e.clientX); });
  canvas.addEventListener('pointerup', () => { dragging = false; });
  canvas.addEventListener('pointercancel', () => { dragging = false; });

  // –Ø–≤–Ω—ã–π —Ç–∞—á-–∫–æ–Ω—Ç—Ä–æ–ª –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
  canvas.addEventListener('touchstart', e => {
    e.preventDefault();
    if (e.touches[0]) movePlayerTo(e.touches[0].clientX);
  }, { passive: false });
  canvas.addEventListener('touchmove', e => {
    e.preventDefault();
    if (e.touches[0]) movePlayerTo(e.touches[0].clientX);
  }, { passive: false });

  window.addEventListener('keydown', e => {
    if(e.key === 'ArrowLeft') player.x = clamp(player.x - 36, 0, canvas.width - player.w);
    if(e.key === 'ArrowRight') player.x = clamp(player.x + 36, 0, canvas.width - player.w);
  });

  shareBtn.onclick = async () => {
    const name = (playerName.value || 'player').replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9_\- ]/g, '').trim().slice(0,20) || 'player';
    const payload = `score_submit|game=pong10|name=${encodeURIComponent(name)}|score=${finalScore}|ts=${Date.now()}`;
    const text = `@stas_a_bot ${payload}`;

    // 1) –í—Å–µ–≥–¥–∞ –∫–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –∫–∞–∫ —Å–∞–º—ã–π –Ω–∞–¥—ë–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
    let copied = false;
    try { await navigator.clipboard.writeText(text); copied = true; } catch (_) {}

    // 2) –ü—Ä–æ–±—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π —à–∞—Ä–∏–Ω–≥
    if (navigator.share) {
      try {
        await navigator.share({ text });
        return;
      } catch (_) {}
    }

    // 3) –ü—Ä–æ–±—É–µ–º –æ—Ç–∫—Ä—ã—Ç—å Telegram app; –µ—Å–ª–∏ –Ω–µ –≤—ã—à–ª–æ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –±–æ—Ç–∞
    const deepLinkMsg = `tg://msg_url?text=${encodeURIComponent(text)}`;
    const deepLinkBot = `tg://resolve?domain=stas_a_bot`;
    const webBot = `https://t.me/stas_a_bot`;

    window.location.href = deepLinkMsg;
    setTimeout(() => {
      window.location.href = deepLinkBot;
      setTimeout(() => window.open(webBot, '_blank'), 600);
    }, 500);

    if (copied) {
      setTimeout(() => {
        alert('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω. –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã–ª—Å—è —Å–∞–π—Ç Telegram, –æ—Ç–∫—Ä–æ–π @stas_a_bot –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏ –≤—Å—Ç–∞–≤—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Ä—É—á–Ω—É—é.');
      }, 1200);
    }
  };

  challengeBtn.onclick = async () => {
    const name = (playerName.value || 'player').replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9_\- ]/g, '').trim().slice(0,20) || 'player';
    const challengeText = `üèì ${name} –Ω–∞–±—Ä–∞–ª ${finalScore} –≤ Pong10. –ö—Ç–æ –ø–æ–±—å—ë—Ç?\n${location.href}`;
    try { await navigator.clipboard.writeText(challengeText); } catch (_) {}
    if (navigator.share) {
      try { await navigator.share({ text: challengeText }); return; } catch (_) {}
    }
    const tg = `https://t.me/share/url?text=${encodeURIComponent(challengeText)}`;
    window.open(tg, '_blank');
  };

  renderLocalLb();
  draw();
})();
</script>
</body>
</html>
